<template>
  <div
    class="cup-container"
    v-if="users && cup && selectedGroup && cupStandings"
  >
    <vs-popup
      v-if="players && selectedMatch"
      class="holamundo"
      :title="
        `${users[selectedMatch.team1.id].userTeam} vs ${
          users[selectedMatch.team2.id].userTeam
        }`
      "
      :active.sync="matchPopup"
      stylePopup="width:70%"
    >
      <CupMatchPopup :players="players" :match="selectedMatch" :users="users" />
    </vs-popup>
    <div class="cup-menu">
      <div class="cup-header">
        <h2 class="up">Battle Stages</h2>
      </div>

      <div class="cup-stages">
        <a
          href="#"
          class="sha cup-stages-links up"
          :class="{ selected: group.name === selectedGroup.name }"
          v-for="group in Object.values(cup)"
          @click.prevent="groupSelectionHandler(group)"
          :key="group.name"
          >{{ group.name }}</a
        >
      </div>
    </div>

    <!-- GROUP A -->
    <section class="group-a">
      <!-- <div class="group-left">
        <img src="images/group-a.png" alt="Group A" srcset="" />
      </div> -->
      <div class="group-center">
        <Standings
          v-if="cupStandings[selectedGroup.name]"
          :standings="cupStandings[selectedGroup.name]"
          :users="users"
          :title="`Group ${selectedGroup.name}`"
        />
        <!-- GROUP MATCHES -->

        <div class="group-matches sha">
          <div class="matches-header">
            <h2 class="up">Group Matches</h2>
          </div>

          <!-- GAMEWEEKS -->

          <div
            class="gameweeks up"
            v-for="(round, i) in Object.values(selectedGroup.rounds)"
            :key="i"
          >
            <div class="gameweeks-header">
              <h2 class="up">Gameweek {{ i + 1 }}</h2>
            </div>
            <div
              class="gameweeks-match-wrapper"
              v-for="(match, i) in roundIntoArray(round)"
              :key="i"
              @click="openMatchPopupHandler(match)"
            >
              <span class="team1">{{ users[match.team1.id].userTeam }}</span>
              <img
                :src="
                  require(`@/assets/images/team-logos/${
                    users[match.team1.id].userLogo
                  }.png`)
                "
                alt=""
                srcset=""
              />
              <span class="score" v-if="match.team1.squad && match.team2.squad"
                >{{ calculateTeamPts(match.team1.squad) }} -
                {{ calculateTeamPts(match.team2.squad) }}</span
              >
              <span class="score" v-else
                > - </span>

              <img
                :src="
                  require(`@/assets/images/team-logos/${
                    users[match.team2.id].userLogo
                  }.png`)
                "
                alt=""
                srcset=""
              />
              <span class="team2">{{ users[match.team2.id].userTeam }}</span>
              <a href="#" class="match-details"
                ><img
                  :src="require(`@/assets/images/cup/soccer-field.png`)"
                  alt=""
              /></a>
            </div>

            <span class="bye-team up" v-if="isThereBye"
              ><img
                :src="
                  require(`@/assets/images/team-logos/${
                    users[showByeTeam(i)].userLogo
                  }.png`)
                "
                alt=""
              />{{ users[showByeTeam(i)].userTeam }} - bye</span
            >
          </div>
        </div>
      </div>
      <!-- <div class="group-right">
        <img src="images/cup.png" alt="Group A" srcset="" />
      </div> -->
    </section>
  </div>
</template>

<script>
import { mapGetters, mapActions } from "vuex";
import cupStandingsHelper from "../../utils/cupStandingsHelper";
import CupMatchPopup from "./CupMatchPopup";
import Standings from "../H2H/Standings";

export default {
  name: "Cup",
  components: {
    CupMatchPopup,
    Standings
  },
  props: {},
  data() {
    return {
      selectedGroup: undefined,
      cupStandings: undefined,
      matchPopup: false,
      selectedMatch: undefined
    };
  },
  computed: {
    ...mapGetters(["cup", "users", "players"]),
    isThereBye() {
      return Object.keys(this.selectedGroup.teams).length % 2 === 1;
    }
    // playingTeams(){
    //   if (this.isThereBye) {
    //     return this.
    //   }
    // }
  },
  methods: {
    ...mapActions(["fetchCup"]),
    roundIntoArray(target) {
      return Object.values(target).slice(0, -1);
    },
    showByeTeam(i) {
      const roundNum = `r${i + 1}`;
      const round = this.selectedGroup.rounds[roundNum];
      const matches = Object.values(round).slice(0, -1);

      // console.log(round, matches);

      return this.selectedGroup.teams.filter(x => {
        let teamsPlayed = [];
        matches.forEach(match => {
          teamsPlayed.push(match.team1.id);
          teamsPlayed.push(match.team2.id);
        });
        if (!teamsPlayed.includes(x)) {
          return x;
        }
      })[0];
    },
    groupSelectionHandler(v) {
      return (this.selectedGroup = v);
    },
    calculateTeamPts(team) {
      // console.log("team", team);
      return Object.values(team).reduce((acc, player) => {
        return player.pts + acc;
      }, 0);
    },
    sortStandingsTeams(teams) {
      return Object.entries(teams)
        .sort((a, b) => {
          return b[1].goaldiff - a[1].goaldiff;
        })
        .sort((a, b) => {
          return b[1].pts - a[1].pts;
        });
    },
    openMatchPopupHandler(match) {
      this.selectedMatch = match;
      return (this.matchPopup = true);
    }
  },
  watch: {
    cup(nv) {
      if (nv) {
        this.cupStandings = cupStandingsHelper(nv);
      }
    }
  },
  async created() {
    await this.fetchCup();
    this.selectedGroup = Object.values(this.cup)[0];
  },
  mounted() {}
};
</script>

<!-- Add "scoped" attribute to limit CSS to this component only -->
<style scoped lang="scss">
con-vs-popup .vs-popup {
  width: 70% !important;
}

.cup-container {
  width: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background-color: #c6c6c6;
  position: relative;
  margin: 20px 0 0 0;
}

.cup-menu {
  width: 70%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background-color: #c6c6c6;
}

.cup-header {
  width: 100%;
}

.cup-header h2 {
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
  width: 100%;
  height: 50px;
  background-color: #3c474d;
  color: #d3d3d3;
  font-size: 1.5rem;
  border-bottom: 5px solid #893e40;
}

.cup-stages {
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
  width: 100%;
  height: 50px;
  margin: 20px 0 0 0;
  color: #d3d3d3;
  font-size: 1.25rem;
}

.cup-stages-links {
  width: 19%;
  height: 100%;
  background-color: #893e40;
  color: #d3d3d3;
  font-size: 1.25rem;
  border-bottom: 5px solid #3c474d;
  text-decoration: none;
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
  position: relative;
  transition: all 0.3s;
}

.cup-stages-links:hover {
  text-decoration: underline;
  background-color: #712f32;
}

.cup-stages-links:nth-child(2),
.cup-stages-links:nth-child(4) {
  margin: 0 20px;
}

.selected {
  background-color: #3c474d;
  border: 3px solid #893e40;
}

.selected::before {
  position: absolute;
  content: "";
  width: 5px;
  height: 20px;
  top: -23px;
  left: 49%;
  background-color: #893e40;
}

/**************************************************
****************  GROUPS **************************/
.group-a,
.group-b,
.group-c,
.group-d,
.elimination {
  width: 100%;
  display: flex;
  flex-direction: row;
  justify-content: space-around;
  align-items: flex-start;
  margin: 20px 0 0 0;
  transition: all 0.3s;
}

.group-left,
.group-right {
  width: 25%;
  margin: 0 20px;
}

.group-left img,
.group-right img {
  width: 100%;
}

.group-center {
  width: 50%;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
}

// .group-standings {
//   width: 100%;
//   font-size: 0.875rem;
// }

// .standings-header {
//   width: 100%;
//   height: 40px;
//   display: flex;
//   flex-direction: row;
//   justify-content: space-between;
//   align-items: center;
//   background-color: #3c474d;
//   border-bottom: 2px solid #893e40;
//   color: #d3d3d3;
//   text-align: center;
// }

// .team-stats {
//   width: 100%;
//   height: 40px;
//   display: flex;
//   flex-direction: row;
//   justify-content: space-between;
//   align-items: center;
//   background-color: #d3d3d3;
//   color: #3c474d;
//   margin: 0 0 5px 0;
//   text-align: start;
//   cursor: pointer;
//   transition: all 0.2s;
// }

// .team-stats:hover {
//   background-color: #bbbbbb;
//   transform: scale(1.02);
// }

// .first-places {
//   background-color: #bcc4c8;
//   border-left: 5px solid #893e40;
//   transition: all 0.3s;
// }

// .first-places:hover {
//   background-color: #a6aeb3;
// }

// .position {
//   width: 7%;
//   text-align: center;
// }

// .team {
//   width: 30%;
//   text-align: start;
// }

// .team a {
//   color: #3c474d;
//   text-decoration: none;
//   transition: all 0.2s;
// }

// .team a:hover {
//   color: #3c474d;
//   text-decoration: underline;
// }

// .games {
//   width: 10%;
//   text-align: center;
// }

// .win-draw-lose {
//   width: 15%;
//   text-align: center;
// }

// .goal-diff {
//   width: 10%;
//   text-align: center;
// }

// .points {
//   width: 7%;
//   text-align: center;
// }

/******** GAMEWEEKS *********************/
.group-matches {
  width: 100%;
  background-color: #cccccc;
  margin: 20px 0 0 0;
}

.gameweeks {
  width: 100%;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
}

.matches-header {
  width: 100%;
}

.matches-header h2 {
  width: 100%;
  background-color: #3c474d;
  color: #d3d3d3;
  border-bottom: 2px solid #893e40;
  height: 40px;
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
  font-size: 1.125rem;
}

.gameweeks {
  padding: 20px;
  width: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color: #3c474d;
  position: relative;
}

.gameweeks-header {
  width: 100%;
  border-bottom: 1px solid #3c474d;
  font-size: 0.875rem;
  padding: 0 0 5px 0;
}

.gameweeks-match-wrapper {
  width: 100%;
  height: 50px;
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
  border-bottom: 1px solid #b1b2b2;
  text-align: center;
  transition: all 0.4s;
  font-size: 0.9rem;
  font-weight: bold;
}

.gameweeks-match-wrapper:hover {
  background-color: #bbbbbb;
  cursor: pointer;
}

.gameweeks-match-wrapper .team1,
.gameweeks-match-wrapper .team2 {
  width: 37%;
}

.gameweeks-match-wrapper .score {
  width: 10%;
}

.gameweeks-match-wrapper img {
  width: 5%;
}

.match-details {
  position: absolute;
  right: 30px;
}

.match-details img {
  width: 20px;
  transition: all 0.2s;
}

.match-details img:hover {
  transform: scale(1.5);
}

.bye-team {
  margin: 20px 0 0 0;
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
}

.bye-team img {
  width: 30px;
  margin: 0 10px 0 0;
}

/*************************************************************
********* ELIMINATION ***************************************/

.elimination-matches {
  width: 135%;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  background-color: #d3d3d3;
}

.elimination-stages {
  width: 100%;
  height: 30px;
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  background-color: #c6c6c6;
}

.elimination-stages h2 {
  width: 20%;
  text-align: center;
  font-size: 0.875rem;
}

.elimination-matches-wrapper {
  width: 100%;
  padding: 30px;
  display: grid;
  grid-column-gap: 30px;
  grid-row-gap: 10px;
  grid-template-columns: repeat(5, 1fr);
  grid-template-rows: repeat(3, 1fr);
}

/********** ELIMINATION MATCHES POSITIONS ************/
.quarter1 {
  grid-row: 1 / span 1;
  grid-column: 1 / span 1;
}

.quarter2 {
  grid-row: 3 / span 1;
  grid-column: 1 / span 1;
}

.quarter3 {
  grid-row: 1 / span 1;
  grid-column: 5 / span 1;
}

.quarter4 {
  grid-row: 3 / span 1;
  grid-column: 5 / span 1;
}

.semi1 {
  grid-row: 2 / span 1;
  grid-column: 2 / span 1;
}

.semi2 {
  grid-row: 2 / span 1;
  grid-column: 4 / span 1;
}

.final {
  grid-row: 3 / span 1;
  grid-column: 3 / span 1;
}

.winner {
  grid-row: 1 / span 1;
  grid-column: 3 / span 1;
}

.match {
  width: 100%;
  background-color: #c6c6c6;
  display: flex;
  flex-direction: column;
  justify-content: space-evenly;
  align-items: center;
  transition: all 0.3s;
}

.match:hover {
  transform: scale(1.05);
  cursor: pointer;
}

.quarter1:hover .row2,
.quarter2:hover .row2,
.quarter3:hover .row2,
.quarter4:hover .row2 {
  background-color: #a6aeb3;
}

.semi1:hover .row2,
.semi2:hover .row2 {
  background-color: #222a2e;
}

.final:hover .row2 {
  background-color: #692a2c;
}

.row1,
.row3 {
  width: 100%;
  height: 40px;
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
  position: relative;
  font-size: 1rem;
  text-align: center;
}

.row1 img,
.row3 img {
  width: 25px;
  position: absolute;
  left: 10px;
}

.row2 {
  width: 100%;
  height: 40px;
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
  position: relative;
  background-color: #bcc4c8;
  border-bottom: 1px solid #b1b2b2;
  border-top: 1px solid #b1b2b2;
  font-size: 1.125rem;
}

.row2 a {
  right: 10px;
  top: 25%;
}

.semis {
  background-color: #3c474d;
  color: #d3d3d3;
}

.row2 a img {
  transition: all 0.3s;
}

.row2 a img:hover {
  transform: scale(1.2);
}

.final-match {
  background-color: #893e40;
  color: #d3d3d3;
}

.winner {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.winner a {
  color: #3c474d;
  text-decoration: none;
  font-size: 1.125rem;
  margin: 20px 0 0 0;
}

.winner a:hover {
  text-decoration: underline;
}
</style>